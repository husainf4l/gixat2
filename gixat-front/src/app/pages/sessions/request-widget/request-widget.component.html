<div class="min-h-screen bg-slate-50">
  <div class="max-w-6xl mx-auto px-6 py-16">
    
    <!-- Navigation Header -->
    <div class="flex items-center justify-between mb-10">
      <div class="flex items-center gap-6">
        <button
          (click)="goBack()"
          class="inline-flex items-center gap-2 text-[11px] font-bold text-slate-400 uppercase tracking-widest hover:text-[#1b75bc] transition-all group"
        >
          <div class="w-8 h-8 rounded-full bg-white border border-slate-200/60 group-hover:border-[#1b75bc]/30 flex items-center justify-center transition-all shadow-sm">
            <i class="ri-arrow-left-line text-lg"></i>
          </div>
          <span>Back to Session</span>
        </button>
        
        <div class="h-6 w-px bg-slate-200"></div>

        @if (sessionDetail()) {
          <span class="px-4 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded-full flex items-center gap-2 text-[9px] font-black uppercase tracking-widest">
            <i [class]="stepIcon() + ' text-sm'"></i>
            {{ stepTitle() }}
          </span>
        }
      </div>

      <div class="flex items-center gap-3">
        @if (isSaving()) {
          <div class="inline-flex items-center gap-2 px-3.5 py-2 bg-white border border-slate-200 rounded-lg">
            <div class="w-4 h-4 border-2 border-slate-200 border-t-[#1b75bc] rounded-full animate-spin"></div>
            <span class="text-sm text-slate-600">Saving...</span>
          </div>
        }
        <button
          (click)="save()"
          [disabled]="isSaving() || (stepId() !== 'initialReport' && !hasValidRequests())"
          class="inline-flex items-center gap-2 px-4 py-2 bg-[#1b75bc] text-white text-sm font-medium rounded-lg hover:bg-[#155a92] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i [class]="stepId() === 'initialReport' ? 'ri-file-list-3-line' : 'ri-save-line'"></i>
          <span>{{ stepId() === 'initialReport' ? (sessionDetail()?.initialReport ? 'Update Report' : 'Generate Report') : 'Save & Continue' }}</span>
        </button>
      </div>
    </div>

    <!-- Main Workspace -->
    <div class="grid grid-cols-12 gap-6">
      
      <!-- Entry Column -->
      <div class="col-span-8 space-y-6">
        
        <!-- Context Banner -->
        <div class="p-6 bg-[#1b75bc] rounded-xl text-white shadow-sm">
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
              <i class="ri-information-line text-lg"></i>
            </div>
            <div>
              <p class="text-xs font-medium opacity-90 mb-1">Documentation Guidelines</p>
              <p class="text-sm text-white/90">Systematic documentation ensures operational transparency and liability protection.</p>
            </div>
          </div>
        </div>

        @if (stepId() === 'initialReport') {
          <!-- Report Display View -->
          <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
              <div class="flex items-center gap-3">
                <i class="ri-file-text-line text-xl text-[#1b75bc]"></i>
                <h3 class="text-lg font-semibold text-slate-900">Diagnostic Report</h3>
              </div>
              <span class="inline-flex px-2.5 py-1 bg-blue-50 text-[#1b75bc] rounded text-xs font-semibold border border-blue-200">Compiled</span>
            </div>

            @if (sessionDetail()?.initialReport; as report) {
              <div class="p-6 bg-slate-50 border border-slate-200 rounded-lg">
                <pre class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap font-normal">{{ report }}</pre>
              </div>
            } @else {
              <div class="py-12 text-center">
                <div class="w-16 h-16 bg-slate-50 rounded-lg flex items-center justify-center mx-auto mb-4">
                  <i class="ri-file-search-line text-3xl text-slate-300"></i>
                </div>
                <p class="text-sm text-slate-500">Ready for compilation. Click the button to generate the diagnostic report.</p>
              </div>
            }
          </div>
        } @else {
          <!-- Entry Form View -->
          <div class="space-y-6">
            <!-- Mileage Input for Inspection -->
            @if (stepId() === 'inspection') {
              <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <div class="mb-4">
                  <label class="text-xs font-medium text-slate-600 mb-2 block">Odometer Reading</label>
                  <div class="relative max-w-xs">
                    <input
                      type="number"
                      [(ngModel)]="mileage"
                      placeholder="Enter mileage"
                      class="w-full pl-4 pr-12 py-2.5 bg-white border border-slate-200 rounded-lg text-base font-semibold text-slate-900 focus:outline-none focus:ring-2 focus:ring-[#1b75bc] focus:border-transparent transition-all placeholder:text-slate-400"
                    />
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-sm font-medium text-[#1b75bc]">km</span>
                  </div>
                </div>
              </div>
            }

            <!-- Targets/Requests Section -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold text-slate-900">Service Targets</h3>
                <span class="text-xs text-slate-500">Add one per line</span>
              </div>

              <div class="space-y-3">
                @for (req of requests(); track $index) {
                  <div class="relative group">
                    <textarea
                      #reqInput
                      [value]="req"
                      (input)="updateRequest($index, $any($event.target).value)"
                      (keydown)="handleRequestKeydown($event, $index)"
                      placeholder="Enter service target..."
                      class="request-input w-full pl-10 pr-10 py-3 bg-white border border-slate-200 rounded-lg text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-[#1b75bc] focus:border-transparent transition-all placeholder:text-slate-400 resize-none overflow-hidden min-h-[48px]"
                    ></textarea>
                    <div class="absolute left-3 top-3 w-6 h-6 rounded bg-slate-100 flex items-center justify-center text-xs font-semibold text-slate-500">
                      {{ $index + 1 }}
                    </div>
                    <button
                      (click)="removeRequest($index)"
                      class="absolute right-3 top-3 w-6 h-6 rounded bg-red-50 text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600 hover:bg-red-100 transition-all flex items-center justify-center"
                    >
                      <i class="ri-close-line text-sm"></i>
                    </button>
                  </div>
                }
                
                <button
                  (click)="addRequest()"
                  class="w-full py-3 border-2 border-dashed border-slate-200 rounded-lg text-sm font-medium text-slate-600 hover:border-[#1b75bc] hover:text-[#1b75bc] hover:bg-blue-50 transition-all flex items-center justify-center gap-2"
                >
                  <i class="ri-add-line"></i>
                  <span>Add Another Target</span>
                </button>
              </div>
            </div>

            <!-- Observations Section -->
            <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-slate-900 mb-2">Technician Observations</h3>
                <p class="text-xs text-slate-500">Add comprehensive notes and findings</p>
              </div>
              <textarea
                [(ngModel)]="notes"
                placeholder="Enter technician observations and summary..."
                class="w-full px-4 py-3 bg-white border border-slate-200 rounded-lg text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-[#1b75bc] focus:border-transparent transition-all placeholder:text-slate-400 min-h-[120px] leading-relaxed resize-none"
              ></textarea>
            </div>
          </div>
        }
      </div>

      <!-- Assets Sideboard -->
      <div class="col-span-4 space-y-6">
        
        <!-- Media Management -->
        <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
          <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
            <h3 class="text-sm font-semibold text-slate-900">Media Gallery</h3>
            <span class="inline-flex px-2 py-0.5 bg-blue-50 text-[#1b75bc] rounded text-xs font-medium border border-blue-200">{{ getMediaByStage().length }} Files</span>
          </div>

          <div class="p-6">
            <!-- Upload Control -->
            <div class="mb-6">
              <label class="relative block group cursor-pointer">
                <input type="file" (change)="onMediaUpload($event)" multiple accept="image/*,video/*" class="hidden">
                <div class="w-full py-6 border-2 border-dashed border-slate-200 rounded-lg flex flex-col items-center justify-center transition-all group-hover:border-[#1b75bc] group-hover:bg-blue-50">
                  <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center mb-2 group-hover:bg-[#1b75bc]/10 transition-all">
                    <i class="ri-camera-line text-xl text-slate-400 group-hover:text-[#1b75bc]"></i>
                  </div>
                  <p class="text-sm font-medium text-slate-600 group-hover:text-[#1b75bc]">Upload Media</p>
                  <p class="text-xs text-slate-400 mt-1">Images or videos</p>
                </div>
              </label>
            </div>

            <!-- Asset Grid -->
            @if (getMediaByStage().length > 0) {
              <div class="grid grid-cols-2 gap-2">
                @for (m of getMediaByStage(); track m.id) {
                  <div class="relative aspect-square rounded-lg overflow-hidden border border-slate-200 group cursor-pointer">
                    <img [src]="m.media.url" [alt]="m.media.alt || ''" class="w-full h-full object-cover">
                    
                    <!-- Hover Overlay -->
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/50 transition-all flex items-center justify-center">
                      <button
                        (click)="deleteMedia(m); $event.stopPropagation()"
                        class="w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
                      >
                        <i class="ri-delete-bin-line text-sm"></i>
                      </button>
                    </div>

                    @if (m.status === 'uploading' || m.status === 'pending') {
                      <div class="absolute inset-0 bg-white/90 flex items-center justify-center">
                        <div class="text-center">
                          <div class="w-6 h-6 border-2 border-slate-200 border-t-[#1b75bc] rounded-full animate-spin mx-auto mb-2"></div>
                          <p class="text-xs text-slate-500">Uploading...</p>
                        </div>
                      </div>
                    }
                    
                    @if (m.status === 'error') {
                      <div class="absolute inset-0 bg-red-50/90 flex items-center justify-center">
                        <div class="text-center">
                          <i class="ri-error-warning-line text-red-500 text-xl mb-1"></i>
                          <p class="text-xs text-red-600">Failed</p>
                          <button
                            (click)="retryUpload(m); $event.stopPropagation()"
                            class="mt-1 text-xs text-[#1b75bc] hover:underline"
                          >
                            Retry
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="py-8 text-center">
                <i class="ri-image-2-line text-3xl text-slate-300 mb-2 block"></i>
                <p class="text-sm text-slate-500">No media uploaded</p>
              </div>
            }
          </div>
        </div>

        <!-- Session Info -->
        <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
          <h3 class="text-sm font-semibold text-slate-900 mb-4">Session Details</h3>
          
          @if (sessionDetail()?.customer) {
            <div class="flex items-center gap-3 mb-4 pb-4 border-b border-slate-100">
              <div class="w-10 h-10 rounded-lg bg-[#1b75bc] flex items-center justify-center text-white font-semibold text-sm">
                {{ sessionDetail()!.customer!.firstName[0] }}{{ sessionDetail()!.customer!.lastName[0] }}
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-slate-900 truncate">{{ sessionDetail()!.customer!.firstName }} {{ sessionDetail()!.customer!.lastName }}</p>
                <p class="text-xs text-slate-500 truncate">{{ sessionDetail()!.customer!.phoneNumber }}</p>
              </div>
            </div>
          }
          
          @if (sessionDetail()?.car) {
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="ri-car-line text-lg"></i>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-slate-900 truncate">{{ sessionDetail()!.car!.make }} {{ sessionDetail()!.car!.model }}</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="px-2 py-0.5 bg-slate-100 rounded text-xs font-mono text-slate-600 border border-slate-200">{{ sessionDetail()!.car!.licensePlate }}</span>
                  <span class="text-xs text-slate-500">{{ sessionDetail()!.car!.year }}</span>
                </div>
              </div>
            </div>
          }
        </div>

      </div>
    </div>
  </div>
</div>
